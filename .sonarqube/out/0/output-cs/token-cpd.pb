ÝJ
q/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Services/RabbitMQService.cs
	namespace 	
CameraService
 
. 
Services  
;  !
public		 
class		 
RabbitMQService		 
:		 
IRabbitMQService		 /
,		/ 0
IDisposable		1 <
{

 
private 
IConnection 
_connection #
;# $
private 
IModel 
_channel 
; 
private 
readonly 
ILogger 
< 
RabbitMQService ,
>, -
_logger. 5
;5 6
private 
const 
string 
ExchangeName %
=& '
$str( 7
;7 8
private 
const 
string 
	QueueName "
=# $
$str% <
;< =
private 
const 
string 

RoutingKey #
=$ %
$str& =
;= >
private 
static 
readonly 
Counter #%
CameraStatusChangeCounter$ =
=> ?
Metrics@ G
. 	
CreateCounter	 
( 
$str 4
,4 5
$str6 ]
,] ^
new  
CounterConfiguration $
{ 

LabelNames 
= 
new  
[  !
]! "
{# $
$str% 2
,2 3
$str4 <
}= >
} 
) 
; 
private 
static 
readonly 
Gauge !
ActiveCamerasGauge" 4
=5 6
Metrics7 >
. 	
CreateGauge	 
( 
$str *
,* +
$str, F
)F G
;G H
private 
static 
readonly 
	Histogram %!
MessageProcessingTime& ;
=< =
Metrics> E
. 	
CreateHistogram	 
( 
$str <
,< =
$str >
,> ?
new   "
HistogramConfiguration   &
{!! 
Buckets"" 
="" 
	Histogram"" #
.""# $
ExponentialBuckets""$ 6
(""6 7
$num""7 ;
,""; <
$num""= >
,""> ?
$num""@ B
)""B C
}## 
)## 
;## 
public%% 

RabbitMQService%% 
(%% 
IConfiguration%% )
configuration%%* 7
,%%7 8
ILogger%%9 @
<%%@ A
RabbitMQService%%A P
>%%P Q
logger%%R X
)%%X Y
{&& 
_logger'' 
='' 
logger'' 
;'' 
try)) 
{** 	
var++ 
factory++ 
=++ 
new++ 
ConnectionFactory++ /
{,, 
HostName-- 
=-- 
configuration-- (
[--( )
$str--) 8
]--8 9
??--: <
$str--= H
,--H I
Port.. 
=.. 
int.. 
... 
Parse..  
(..  !
configuration..! .
[... /
$str../ >
]..> ?
??..@ B
$str..C I
)..I J
,..J K
UserName// 
=// 
configuration// (
[//( )
$str//) <
]//< =
??//> @
$str//A H
,//H I
Password00 
=00 
configuration00 (
[00( )
$str00) <
]00< =
??00> @
$str00A H
}11 
;11 
_connection33 
=33 
factory33 !
.33! "
CreateConnection33" 2
(332 3
)333 4
;334 5
_channel44 
=44 
_connection44 "
.44" #
CreateModel44# .
(44. /
)44/ 0
;440 1
_channel77 
.77 
ExchangeDeclare77 $
(77$ %
ExchangeName77% 1
,771 2
ExchangeType773 ?
.77? @
Topic77@ E
,77E F
durable77G N
:77N O
true77P T
)77T U
;77U V
_channel88 
.88 
QueueDeclare88 !
(88! "
	QueueName88" +
,88+ ,
durable88- 4
:884 5
true886 :
,88: ;
	exclusive88< E
:88E F
false88G L
,88L M

autoDelete88N X
:88X Y
false88Z _
)88_ `
;88` a
_channel99 
.99 
	QueueBind99 
(99 
	QueueName99 (
,99( )
ExchangeName99* 6
,996 7

RoutingKey998 B
)99B C
;99C D
_logger;; 
.;; 
LogInformation;; "
(;;" #
$str;;# D
);;D E
;;;E F
}<< 	
catch== 
(== 
	Exception== 
ex== 
)== 
{>> 	
_logger?? 
.?? 
LogError?? 
(?? 
ex?? 
,??  
$str??! I
)??I J
;??J K
throw@@ 
;@@ 
}AA 	
}BB 
publicDD 

TaskDD *
PublishCameraStatusChangeAsyncDD .
(DD. /
stringDD/ 5

cameraCodeDD6 @
,DD@ A
boolDDB F
estAfficherDDG R
)DDR S
{EE 
tryFF 
{GG 	
usingHH 
(HH !
MessageProcessingTimeHH (
.HH( )
NewTimerHH) 1
(HH1 2
)HH2 3
)HH3 4
{II 
varJJ 
messageJJ 
=JJ 
newJJ !&
CameraStatusChangedMessageJJ" <
{KK 

CameraCodeLL 
=LL  

cameraCodeLL! +
,LL+ ,
EstAfficherMM 
=MM  !
estAfficherMM" -
,MM- .
	TimestampNN 
=NN 
DateTimeNN  (
.NN( )
UtcNowNN) /
}OO 
;OO 
varQQ 
messageBodyQQ 
=QQ  !
JsonSerializerQQ" 0
.QQ0 1
	SerializeQQ1 :
(QQ: ;
messageQQ; B
)QQB C
;QQC D
varRR 
bodyRR 
=RR 
EncodingRR #
.RR# $
UTF8RR$ (
.RR( )
GetBytesRR) 1
(RR1 2
messageBodyRR2 =
)RR= >
;RR> ?
_channelTT 
.TT 
BasicPublishTT %
(TT% &
exchangeUU 
:UU 
ExchangeNameUU *
,UU* +

routingKeyVV 
:VV 

RoutingKeyVV  *
,VV* +
basicPropertiesWW #
:WW# $
nullWW% )
,WW) *
bodyXX 
:XX 
bodyXX 
)XX 
;XX  %
CameraStatusChangeCounter[[ )
.[[) *

WithLabels[[* 4
([[4 5

cameraCode[[5 ?
,[[? @
estAfficher[[A L
?[[M N
$str[[O Z
:[[[ \
$str[[] j
)[[j k
.[[k l
Inc[[l o
([[o p
)[[p q
;[[q r
if^^ 
(^^ 
estAfficher^^ 
)^^  
{__ 
ActiveCamerasGauge`` &
.``& '
Inc``' *
(``* +
)``+ ,
;``, -
}aa 
elsebb 
{cc 
ActiveCamerasGaugedd &
.dd& '
Decdd' *
(dd* +
)dd+ ,
;dd, -
}ee 
_loggergg 
.gg 
LogInformationgg &
(gg& '
$"gg' )
$strgg) @
{gg@ A

cameraCodeggA K
}ggK L
$strggL Q
{ggQ R
(ggR S
estAfficherggS ^
?gg_ `
$strgga k
:ggl m
$strggn w
)ggw x
}ggx y
"ggy z
)ggz {
;gg{ |
}hh 
returnjj 
Taskjj 
.jj 
CompletedTaskjj %
;jj% &
}kk 	
catchll 
(ll 
	Exceptionll 
exll 
)ll 
{mm 	
_loggernn 
.nn 
LogErrornn 
(nn 
exnn 
,nn  
$"nn! #
$strnn# [
{nn[ \

cameraCodenn\ f
}nnf g
"nng h
)nnh i
;nni j
returnoo 
Taskoo 
.oo 
CompletedTaskoo %
;oo% &
}pp 	
}qq 
publicss 

voidss 
Disposess 
(ss 
)ss 
{tt 
_channeluu 
?uu 
.uu 
Closeuu 
(uu 
)uu 
;uu 
_connectionvv 
?vv 
.vv 
Closevv 
(vv 
)vv 
;vv 
_channelww 
?ww 
.ww 
Disposeww 
(ww 
)ww 
;ww 
_connectionxx 
?xx 
.xx 
Disposexx 
(xx 
)xx 
;xx 
}yy 
}zz 
public|| 
	interface|| 
IRabbitMQService|| !
{}} 
Task~~ *
PublishCameraStatusChangeAsync~~	 '
(~~' (
string~~( .

cameraCode~~/ 9
,~~9 :
bool~~; ?
estAfficher~~@ K
)~~K L
;~~L M
}  _
`/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
AddControllers 
(  
)  !
;! "
builder

 
.

 
Services

 
.

 #
AddEndpointsApiExplorer

 (
(

( )
)

) *
;

* +
builder 
. 
Services 
. 
AddSwaggerGen 
( 
)  
;  !
builder 
. 
Services 
. 
AddDbContext 
< 
CameraDbContext -
>- .
(. /
options/ 6
=>7 9
options 
. 
	UseNpgsql 
( 
builder 
. 
Configuration +
.+ ,
GetConnectionString, ?
(? @
$str@ S
)S T
)T U
)U V
;V W
builder 
. 
Services 
. 
AddSingleton 
< 
IRabbitMQService .
,. /
RabbitMQService0 ?
>? @
(@ A
)A B
;B C
builder 
. 
Services 
. 
AddCors 
( 
options  
=>! #
{ 
options 
. 
	AddPolicy 
( 
$str  
,  !
builder 
=> 
builder 
. 
AllowAnyOrigin )
() *
)* +
.+ ,
AllowAnyMethod, :
(: ;
); <
.< =
AllowAnyHeader= K
(K L
)L M
)M N
;N O
} 
) 
; 
var 
app 
= 	
builder
 
. 
Build 
( 
) 
; 
if 
( 
app 
. 
Environment 
. 
IsDevelopment !
(! "
)" #
)# $
{ 
app 
. 

UseSwagger 
( 
) 
; 
app 
. 
UseSwaggerUI 
( 
) 
; 
}   
app## 
.## 
UseMetricServer## 
(## 
)## 
;## 
app$$ 
.$$ 
UseHttpMetrics$$ 
($$ 
)$$ 
;$$ 
using'' 
('' 
var'' 

scope'' 
='' 
app'' 
.'' 
Services'' 
.''  
CreateScope''  +
(''+ ,
)'', -
)''- .
{(( 
var)) 
	dbContext)) 
=)) 
scope)) 
.)) 
ServiceProvider)) )
.))) *
GetRequiredService))* <
<))< =
CameraDbContext))= L
>))L M
())M N
)))N O
;))O P
var++ 

retryCount++ 
=++ 
$num++ 
;++ 
const,, 	
int,,
 

maxRetries,, 
=,, 
$num,, 
;,, 
var-- 
delay-- 
=-- 
TimeSpan-- 
.-- 
FromSeconds-- $
(--$ %
$num--% &
)--& '
;--' (
while// 	
(//
 

retryCount// 
<// 

maxRetries// "
)//" #
{00 
try11 
{22 	
	dbContext33 
.33 
Database33 
.33 
Migrate33 &
(33& '
)33' (
;33( )
if66 
(66 
!66 
	dbContext66 
.66 
Cameras66 "
.66" #
Any66# &
(66& '
)66' (
)66( )
{77 
var88 
cameras88 
=88 
new88 !
List88" &
<88& '
Camera88' -
>88- .
{99 
new:: 
Camera:: 
{::  
Nom::! $
=::% &
$str::' A
,::A B
Code::C G
=::H I
$str::J O
,::O P
EstAfficher::Q \
=::] ^
true::_ c
}::d e
,::e f
new;; 
Camera;; 
{;;  
Nom;;! $
=;;% &
$str;;' >
,;;> ?
Code;;@ D
=;;E F
$str;;G L
,;;L M
EstAfficher;;N Y
=;;Z [
true;;\ `
};;a b
,;;b c
new<< 
Camera<< 
{<<  
Nom<<! $
=<<% &
$str<<' <
,<<< =
Code<<> B
=<<C D
$str<<E J
,<<J K
EstAfficher<<L W
=<<X Y
true<<Z ^
}<<_ `
,<<` a
new== 
Camera== 
{==  
Nom==! $
===% &
$str==' ;
,==; <
Code=== A
===B C
$str==D I
,==I J
EstAfficher==K V
===W X
true==Y ]
}==^ _
,==_ `
new>> 
Camera>> 
{>>  
Nom>>! $
=>>% &
$str>>' 9
,>>9 :
Code>>; ?
=>>@ A
$str>>B G
,>>G H
EstAfficher>>I T
=>>U V
true>>W [
}>>\ ]
,>>] ^
new?? 
Camera?? 
{??  
Nom??! $
=??% &
$str??' 9
,??9 :
Code??; ?
=??@ A
$str??B G
,??G H
EstAfficher??I T
=??U V
true??W [
}??\ ]
,??] ^
new@@ 
Camera@@ 
{@@  
Nom@@! $
=@@% &
$str@@' :
,@@: ;
Code@@< @
=@@A B
$str@@C H
,@@H I
EstAfficher@@J U
=@@V W
true@@X \
}@@] ^
,@@^ _
newAA 
CameraAA 
{AA  
NomAA! $
=AA% &
$strAA' :
,AA: ;
CodeAA< @
=AAA B
$strAAC H
,AAH I
EstAfficherAAJ U
=AAV W
trueAAX \
}AA] ^
,AA^ _
newBB 
CameraBB 
{BB  
NomBB! $
=BB% &
$strBB' 9
,BB9 :
CodeBB; ?
=BB@ A
$strBBB G
,BBG H
EstAfficherBBI T
=BBU V
trueBBW [
}BB\ ]
,BB] ^
newCC 
CameraCC 
{CC  
NomCC! $
=CC% &
$strCC' C
,CCC D
CodeCCE I
=CCJ K
$strCCL Q
,CCQ R
EstAfficherCCS ^
=CC_ `
falseCCa f
}CCg h
,CCh i
newDD 
CameraDD 
{DD  
NomDD! $
=DD% &
$strDD' @
,DD@ A
CodeDDB F
=DDG H
$strDDI N
,DDN O
EstAfficherDDP [
=DD\ ]
falseDD^ c
}DDd e
,DDe f
newEE 
CameraEE 
{EE  
NomEE! $
=EE% &
$strEE' 9
,EE9 :
CodeEE; ?
=EE@ A
$strEEB G
,EEG H
EstAfficherEEI T
=EEU V
trueEEW [
}EE\ ]
,EE] ^
newFF 
CameraFF 
{FF  
NomFF! $
=FF% &
$strFF' @
,FF@ A
CodeFFB F
=FFG H
$strFFI N
,FFN O
EstAfficherFFP [
=FF\ ]
trueFF^ b
}FFc d
,FFd e
newGG 
CameraGG 
{GG  
NomGG! $
=GG% &
$strGG' D
,GGD E
CodeGGF J
=GGK L
$strGGM R
,GGR S
EstAfficherGGT _
=GG` a
trueGGb f
}GGg h
,GGh i
newHH 
CameraHH 
{HH  
NomHH! $
=HH% &
$strHH' F
,HHF G
CodeHHH L
=HHM N
$strHHO T
,HHT U
EstAfficherHHV a
=HHb c
trueHHd h
}HHi j
,HHj k
newII 
CameraII 
{II  
NomII! $
=II% &
$strII' ?
,II? @
CodeIIA E
=IIF G
$strIIH M
,IIM N
EstAfficherIIO Z
=II[ \
trueII] a
}IIb c
,IIc d
newJJ 
CameraJJ 
{JJ  
NomJJ! $
=JJ% &
$strJJ' >
,JJ> ?
CodeJJ@ D
=JJE F
$strJJG L
,JJL M
EstAfficherJJN Y
=JJZ [
trueJJ\ `
}JJa b
,JJb c
newKK 
CameraKK 
{KK  
NomKK! $
=KK% &
$strKK' >
,KK> ?
CodeKK@ D
=KKE F
$strKKG L
,KKL M
EstAfficherKKN Y
=KKZ [
trueKK\ `
}KKa b
,KKb c
newLL 
CameraLL 
{LL  
NomLL! $
=LL% &
$strLL' @
,LL@ A
CodeLLB F
=LLG H
$strLLI N
,LLN O
EstAfficherLLP [
=LL\ ]
trueLL^ b
}LLc d
,LLd e
newMM 
CameraMM 
{MM  
NomMM! $
=MM% &
$strMM' D
,MMD E
CodeMMF J
=MMK L
$strMMM R
,MMR S
EstAfficherMMT _
=MM` a
falseMMb g
}MMh i
}NN 
;NN 
	dbContextPP 
.PP 
CamerasPP !
.PP! "
AddRangePP" *
(PP* +
camerasPP+ 2
)PP2 3
;PP3 4
	dbContextQQ 
.QQ 
SaveChangesQQ %
(QQ% &
)QQ& '
;QQ' (
ConsoleSS 
.SS 
	WriteLineSS !
(SS! "
$strSS" \
)SS\ ]
;SS] ^
}TT 
ConsoleVV 
.VV 
	WriteLineVV 
(VV 
$strVV B
)VVB C
;VVC D
breakWW 
;WW 
}XX 	
catchYY 
(YY 
	ExceptionYY 
exYY 
)YY 
{ZZ 	

retryCount[[ 
++[[ 
;[[ 
Console\\ 
.\\ 
	WriteLine\\ 
(\\ 
$"\\  
$str\\  *
{\\* +

retryCount\\+ 5
}\\5 6
$str\\6 7
{\\7 8

maxRetries\\8 B
}\\B C
$str\\C x
{\\x y
ex\\y {
.\\{ |
Message	\\| 
}
\\ 
"
\\ 
)
\\ 
;
\\ 
if^^ 
(^^ 

retryCount^^ 
<^^ 

maxRetries^^ '
)^^' (
{__ 
Console`` 
.`` 
	WriteLine`` !
(``! "
$"``" $
$str``$ <
{``< =
delay``= B
.``B C
TotalSeconds``C O
}``O P
$str``P \
"``\ ]
)``] ^
;``^ _
Threadaa 
.aa 
Sleepaa 
(aa 
delayaa "
)aa" #
;aa# $
}bb 
elsecc 
{dd 
Consoleee 
.ee 
	WriteLineee !
(ee! "
$stree" o
)eeo p
;eep q
throwff 
;ff 
}gg 
}hh 	
}ii 
}jj 
appll 
.ll 
UseCorsll 
(ll 
$strll 
)ll 
;ll 
appmm 
.mm 

UseRoutingmm 
(mm 
)mm 
;mm 
appoo 
.oo 
UseAuthorizationoo 
(oo 
)oo 
;oo 
apppp 
.pp 
MapControllerspp 
(pp 
)pp 
;pp 
apprr 
.rr 
Runrr 
(rr 
)rr 	
;rr	 
Á
o/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Models/CameraDbContext.cs
	namespace 	
CameraService
 
. 
Models 
{ 
public 

class 
CameraDbContext  
:! "
	DbContext# ,
{ 
public 
CameraDbContext 
( 
DbContextOptions /
</ 0
CameraDbContext0 ?
>? @
optionsA H
)H I
: 
base 
( 
options 
) 
{		 	
}

 	
public 
DbSet 
< 
Camera 
> 
Cameras $
{% &
get' *
;* +
set, /
;/ 0
}1 2
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
modelBuilder 
. 
Entity 
<  
Camera  &
>& '
(' (
)( )
.) *
ToTable* 1
(1 2
$str2 :
): ;
;; <
modelBuilder 
. 
Entity 
<  
Camera  &
>& '
(' (
)( )
.) *
Property* 2
(2 3
c3 4
=>5 7
c8 9
.9 :
Id: <
)< =
.= >
HasColumnName> K
(K L
$strL P
)P Q
;Q R
modelBuilder 
. 
Entity 
<  
Camera  &
>& '
(' (
)( )
.) *
Property* 2
(2 3
c3 4
=>5 7
c8 9
.9 :
Nom: =
)= >
.> ?
HasColumnName? L
(L M
$strM R
)R S
;S T
modelBuilder 
. 
Entity 
<  
Camera  &
>& '
(' (
)( )
.) *
Property* 2
(2 3
c3 4
=>5 7
c8 9
.9 :
Code: >
)> ?
.? @
HasColumnName@ M
(M N
$strN T
)T U
;U V
modelBuilder 
. 
Entity 
<  
Camera  &
>& '
(' (
)( )
.) *
Property* 2
(2 3
c3 4
=>5 7
c8 9
.9 :
EstAfficher: E
)E F
.F G
HasColumnNameG T
(T U
$strU c
)c d
;d e
} 	
} 
} ô	
f/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Models/Camera.cs
	namespace 	
CameraService
 
. 
Models 
{ 
public 

class 
Camera 
{ 
[ 	
Key	 
] 
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
[

 	
Required

	 
]

 
[ 	
StringLength	 
( 
$num 
) 
] 
public 
string 
Nom 
{ 
get 
;  
set! $
;$ %
}& '
[ 	
Required	 
] 
[ 	
StringLength	 
( 
$num 
) 
] 
public 
string 
Code 
{ 
get  
;  !
set" %
;% &
}' (
public 
bool 
EstAfficher 
{  !
get" %
;% &
set' *
;* +
}, -
} 
} ±
|/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Migrations/20250412093158_codeAjout.cs
	namespace 	
CameraService
 
. 

Migrations "
{ 
public 

partial 
class 
	codeAjout "
:# $
	Migration% .
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
	AddColumn &
<& '
string' -
>- .
(. /
name 
: 
$str 
, 
table 
: 
$str 
,  
type 
: 
$str -
,- .
	maxLength 
: 
$num 
, 
nullable 
: 
false 
,  
defaultValue 
: 
$str  
)  !
;! "
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 

DropColumn '
(' (
name 
: 
$str 
, 
table 
: 
$str 
)  
;  !
} 	
} 
} È
/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Migrations/20250412085533_InitialCreate.cs
	namespace 	
CameraService
 
. 

Migrations "
{ 
public		 

partial		 
class		 
InitialCreate		 &
:		' (
	Migration		) 2
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str 
, 
columns 
: 
table 
=> !
new" %
{ 
id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
. 

Annotation #
(# $
$str$ D
,D E)
NpgsqlValueGenerationStrategyF c
.c d#
IdentityByDefaultColumnd {
){ |
,| }
nom 
= 
table 
.  
Column  &
<& '
string' -
>- .
(. /
type/ 3
:3 4
$str5 M
,M N
	maxLengthO X
:X Y
$numZ ]
,] ^
nullable_ g
:g h
falsei n
)n o
,o p
est_afficher  
=! "
table# (
.( )
Column) /
</ 0
bool0 4
>4 5
(5 6
type6 :
:: ;
$str< E
,E F
nullableG O
:O P
falseQ V
)V W
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 0
,0 1
x2 3
=>4 6
x7 8
.8 9
id9 ;
); <
;< =
} 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder   
.   
	DropTable   &
(  & '
name!! 
:!! 
$str!! 
)!! 
;!!  
}"" 	
}## 
}$$ ÿ
p/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Messages/CameraMessages.cs
	namespace 	
CameraService
 
. 
Messages  
{ 
public 

class &
CameraStatusChangedMessage +
{ 
public 
string 

CameraCode  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
bool 
EstAfficher 
{  !
get" %
;% &
set' *
;* +
}, -
public		 
DateTime		 
	Timestamp		 !
{		" #
get		$ '
;		' (
set		) ,
;		, -
}		. /
=		0 1
DateTime		2 :
.		: ;
UtcNow		; A
;		A B
}

 
} :
s/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Controllers/SeedController.cs
	namespace 	
CameraService
 
. 
Controllers #
{ 
[ 
ApiController 
] 
[		 
Route		 

(		
 
$str		 
)		 
]		 
public

 

class

 
SeedController

 
:

  !
ControllerBase

" 0
{ 
private 
readonly 
CameraDbContext (
_context) 1
;1 2
public 
SeedController 
( 
CameraDbContext -
context. 5
)5 6
{ 	
_context 
= 
context 
; 
} 	
[ 	
HttpPost	 
] 
public 
async 
Task 
< 
IActionResult '
>' (
SeedData) 1
(1 2
)2 3
{ 	
_context 
. 
Cameras 
. 
RemoveRange (
(( )
_context) 1
.1 2
Cameras2 9
)9 :
;: ;
await 
_context 
. 
SaveChangesAsync +
(+ ,
), -
;- .
var 
cameras 
= 
new 
List "
<" #
Camera# )
>) *
{ 
new 
Camera 
{ 
Nom  
=! "
$str# =
,= >
Code? C
=D E
$strF K
,K L
EstAfficherM X
=Y Z
true[ _
}` a
,a b
new 
Camera 
{ 
Nom  
=! "
$str# :
,: ;
Code< @
=A B
$strC H
,H I
EstAfficherJ U
=V W
trueX \
}] ^
,^ _
new   
Camera   
{   
Nom    
=  ! "
$str  # 8
,  8 9
Code  : >
=  ? @
$str  A F
,  F G
EstAfficher  H S
=  T U
true  V Z
}  [ \
,  \ ]
new!! 
Camera!! 
{!! 
Nom!!  
=!!! "
$str!!# 7
,!!7 8
Code!!9 =
=!!> ?
$str!!@ E
,!!E F
EstAfficher!!G R
=!!S T
true!!U Y
}!!Z [
,!![ \
new"" 
Camera"" 
{"" 
Nom""  
=""! "
$str""# 5
,""5 6
Code""7 ;
=""< =
$str""> C
,""C D
EstAfficher""E P
=""Q R
true""S W
}""X Y
,""Y Z
new## 
Camera## 
{## 
Nom##  
=##! "
$str### 5
,##5 6
Code##7 ;
=##< =
$str##> C
,##C D
EstAfficher##E P
=##Q R
true##S W
}##X Y
,##Y Z
new$$ 
Camera$$ 
{$$ 
Nom$$  
=$$! "
$str$$# 6
,$$6 7
Code$$8 <
=$$= >
$str$$? D
,$$D E
EstAfficher$$F Q
=$$R S
true$$T X
}$$Y Z
,$$Z [
new%% 
Camera%% 
{%% 
Nom%%  
=%%! "
$str%%# 6
,%%6 7
Code%%8 <
=%%= >
$str%%? D
,%%D E
EstAfficher%%F Q
=%%R S
true%%T X
}%%Y Z
,%%Z [
new&& 
Camera&& 
{&& 
Nom&&  
=&&! "
$str&&# 5
,&&5 6
Code&&7 ;
=&&< =
$str&&> C
,&&C D
EstAfficher&&E P
=&&Q R
true&&S W
}&&X Y
,&&Y Z
new'' 
Camera'' 
{'' 
Nom''  
=''! "
$str''# ?
,''? @
Code''A E
=''F G
$str''H M
,''M N
EstAfficher''O Z
=''[ \
false''] b
}''c d
,''d e
new(( 
Camera(( 
{(( 
Nom((  
=((! "
$str((# <
,((< =
Code((> B
=((C D
$str((E J
,((J K
EstAfficher((L W
=((X Y
false((Z _
}((` a
,((a b
new)) 
Camera)) 
{)) 
Nom))  
=))! "
$str))# 5
,))5 6
Code))7 ;
=))< =
$str))> C
,))C D
EstAfficher))E P
=))Q R
true))S W
}))X Y
,))Y Z
new** 
Camera** 
{** 
Nom**  
=**! "
$str**# <
,**< =
Code**> B
=**C D
$str**E J
,**J K
EstAfficher**L W
=**X Y
true**Z ^
}**_ `
,**` a
new++ 
Camera++ 
{++ 
Nom++  
=++! "
$str++# @
,++@ A
Code++B F
=++G H
$str++I N
,++N O
EstAfficher++P [
=++\ ]
true++^ b
}++c d
,++d e
new,, 
Camera,, 
{,, 
Nom,,  
=,,! "
$str,,# B
,,,B C
Code,,D H
=,,I J
$str,,K P
,,,P Q
EstAfficher,,R ]
=,,^ _
true,,` d
},,e f
,,,f g
new-- 
Camera-- 
{-- 
Nom--  
=--! "
$str--# ;
,--; <
Code--= A
=--B C
$str--D I
,--I J
EstAfficher--K V
=--W X
true--Y ]
}--^ _
,--_ `
new.. 
Camera.. 
{.. 
Nom..  
=..! "
$str..# :
,..: ;
Code..< @
=..A B
$str..C H
,..H I
EstAfficher..J U
=..V W
true..X \
}..] ^
,..^ _
new// 
Camera// 
{// 
Nom//  
=//! "
$str//# :
,//: ;
Code//< @
=//A B
$str//C H
,//H I
EstAfficher//J U
=//V W
true//X \
}//] ^
,//^ _
new00 
Camera00 
{00 
Nom00  
=00! "
$str00# <
,00< =
Code00> B
=00C D
$str00E J
,00J K
EstAfficher00L W
=00X Y
true00Z ^
}00_ `
,00` a
new11 
Camera11 
{11 
Nom11  
=11! "
$str11# @
,11@ A
Code11B F
=11G H
$str11I N
,11N O
EstAfficher11P [
=11\ ]
false11^ c
}11d e
}22 
;22 
await55 
_context55 
.55 
Cameras55 "
.55" #
AddRangeAsync55# 0
(550 1
cameras551 8
)558 9
;559 :
await66 
_context66 
.66 
SaveChangesAsync66 +
(66+ ,
)66, -
;66- .
return88 
Ok88 
(88 
$str88 D
)88D E
;88E F
}99 	
}:: 
};; ÄH
v/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/camera-service/CameraService/Controllers/CamerasController.cs
	namespace 	
CameraService
 
. 
Controllers #
{ 
[ 
ApiController 
] 
[		 
Route		 

(		
 
$str		 
)		 
]		 
public

 

class

 
CamerasController

 "
:

# $
ControllerBase

% 3
{ 
private 
readonly 
CameraDbContext (
_context) 1
;1 2
private 
readonly 
IRabbitMQService )
_rabbitMQService* :
;: ;
private 
readonly 
ILogger  
<  !
CamerasController! 2
>2 3
_logger4 ;
;; <
public 
CamerasController  
(  !
CameraDbContext 
context #
,# $
IRabbitMQService 
rabbitMQService ,
,, -
ILogger 
< 
CamerasController %
>% &
logger' -
)- .
{ 	
_context 
= 
context 
; 
_rabbitMQService 
= 
rabbitMQService .
;. /
_logger 
= 
logger 
; 
} 	
[ 	
HttpGet	 
] 
public 
async 
Task 
< 
ActionResult &
<& '
IEnumerable' 2
<2 3
Camera3 9
>9 :
>: ;
>; <

GetCameras= G
(G H
)H I
{ 	
return 
await 
_context !
.! "
Cameras" )
.) *
OrderBy* 1
(1 2
c2 3
=>4 6
c7 8
.8 9
Code9 =
)= >
.> ?
ToListAsync? J
(J K
)K L
;L M
} 	
["" 	
HttpGet""	 
("" 
$str"" 
)"" 
]"" 
public## 
async## 
Task## 
<## 
ActionResult## &
<##& '
Camera##' -
>##- .
>##. /
	GetCamera##0 9
(##9 :
int##: =
id##> @
)##@ A
{$$ 	
var%% 
camera%% 
=%% 
await%% 
_context%% '
.%%' (
Cameras%%( /
.%%/ 0
	FindAsync%%0 9
(%%9 :
id%%: <
)%%< =
;%%= >
if'' 
('' 
camera'' 
=='' 
null'' 
)'' 
{(( 
return)) 
NotFound)) 
())  
)))  !
;))! "
}** 
return,, 
camera,, 
;,, 
}-- 	
[00 	
HttpPost00	 
]00 
public11 
async11 
Task11 
<11 
ActionResult11 &
<11& '
Camera11' -
>11- .
>11. /

PostCamera110 :
(11: ;
Camera11; A
camera11B H
)11H I
{22 	
_context33 
.33 
Cameras33 
.33 
Add33  
(33  !
camera33! '
)33' (
;33( )
await44 
_context44 
.44 
SaveChangesAsync44 +
(44+ ,
)44, -
;44- .
await77 
_rabbitMQService77 "
.77" #*
PublishCameraStatusChangeAsync77# A
(77A B
camera77B H
.77H I
Code77I M
,77M N
camera77O U
.77U V
EstAfficher77V a
)77a b
;77b c
return99 
CreatedAtAction99 "
(99" #
nameof99# )
(99) *
	GetCamera99* 3
)993 4
,994 5
new996 9
{99: ;
id99< >
=99? @
camera99A G
.99G H
Id99H J
}99K L
,99L M
camera99N T
)99T U
;99U V
}:: 	
[== 	
HttpPut==	 
(== 
$str== 
)== 
]== 
public>> 
async>> 
Task>> 
<>> 
IActionResult>> '
>>>' (
	PutCamera>>) 2
(>>2 3
int>>3 6
id>>7 9
,>>9 :
Camera>>; A
camera>>B H
)>>H I
{?? 	
if@@ 
(@@ 
id@@ 
!=@@ 
camera@@ 
.@@ 
Id@@ 
)@@  
{AA 
returnBB 

BadRequestBB !
(BB! "
)BB" #
;BB# $
}CC 
varFF 
	oldCameraFF 
=FF 
awaitFF !
_contextFF" *
.FF* +
CamerasFF+ 2
.FF2 3
AsNoTrackingFF3 ?
(FF? @
)FF@ A
.FFA B
FirstOrDefaultAsyncFFB U
(FFU V
cFFV W
=>FFX Z
cFF[ \
.FF\ ]
IdFF] _
==FF` b
idFFc e
)FFe f
;FFf g
_contextHH 
.HH 
EntryHH 
(HH 
cameraHH !
)HH! "
.HH" #
StateHH# (
=HH) *
EntityStateHH+ 6
.HH6 7
ModifiedHH7 ?
;HH? @
tryJJ 
{KK 
awaitLL 
_contextLL 
.LL 
SaveChangesAsyncLL /
(LL/ 0
)LL0 1
;LL1 2
ifOO 
(OO 
	oldCameraOO 
!=OO  
nullOO! %
&&OO& (
	oldCameraOO) 2
.OO2 3
EstAfficherOO3 >
!=OO? A
cameraOOB H
.OOH I
EstAfficherOOI T
)OOT U
{PP 
_loggerQQ 
.QQ 
LogInformationQQ *
(QQ* +
$"QQ+ -
$strQQ- ?
{QQ? @
cameraQQ@ F
.QQF G
CodeQQG K
}QQK L
$strQQL W
{QQW X
cameraQQX ^
.QQ^ _
EstAfficherQQ_ j
}QQj k
"QQk l
)QQl m
;QQm n
awaitRR 
_rabbitMQServiceRR *
.RR* +*
PublishCameraStatusChangeAsyncRR+ I
(RRI J
cameraRRJ P
.RRP Q
CodeRRQ U
,RRU V
cameraRRW ]
.RR] ^
EstAfficherRR^ i
)RRi j
;RRj k
}SS 
}TT 
catchUU 
(UU (
DbUpdateConcurrencyExceptionUU /
exUU0 2
)UU2 3
{VV 
_loggerWW 
.WW 
LogErrorWW  
(WW  !
exWW! #
,WW# $
$"WW% '
$strWW' a
{WWa b
idWWb d
}WWd e
"WWe f
)WWf g
;WWg h
ifYY 
(YY 
!YY 
CameraExistsYY !
(YY! "
idYY" $
)YY$ %
)YY% &
{ZZ 
return[[ 
NotFound[[ #
([[# $
)[[$ %
;[[% &
}\\ 
else]] 
{^^ 
throw__ 
;__ 
}`` 
}aa 
returncc 
	NoContentcc 
(cc 
)cc 
;cc 
}dd 	
[gg 	

HttpDeletegg	 
(gg 
$strgg 
)gg 
]gg 
publichh 
asynchh 
Taskhh 
<hh 
IActionResulthh '
>hh' (
DeleteCamerahh) 5
(hh5 6
inthh6 9
idhh: <
)hh< =
{ii 	
varjj 
camerajj 
=jj 
awaitjj 
_contextjj '
.jj' (
Camerasjj( /
.jj/ 0
	FindAsyncjj0 9
(jj9 :
idjj: <
)jj< =
;jj= >
ifkk 
(kk 
camerakk 
==kk 
nullkk 
)kk 
{ll 
returnmm 
NotFoundmm 
(mm  
)mm  !
;mm! "
}nn 
_contextpp 
.pp 
Cameraspp 
.pp 
Removepp #
(pp# $
camerapp$ *
)pp* +
;pp+ ,
awaitqq 
_contextqq 
.qq 
SaveChangesAsyncqq +
(qq+ ,
)qq, -
;qq- .
awaittt 
_rabbitMQServicett "
.tt" #*
PublishCameraStatusChangeAsynctt# A
(ttA B
camerattB H
.ttH I
CodettI M
,ttM N
falsettO T
)ttT U
;ttU V
returnvv 
	NoContentvv 
(vv 
)vv 
;vv 
}ww 	
privateyy 
boolyy 
CameraExistsyy !
(yy! "
intyy" %
idyy& (
)yy( )
{zz 	
return{{ 
_context{{ 
.{{ 
Cameras{{ #
.{{# $
Any{{$ '
({{' (
e{{( )
=>{{* ,
e{{- .
.{{. /
Id{{/ 1
=={{2 4
id{{5 7
){{7 8
;{{8 9
}|| 	
}}} 
}~~ 