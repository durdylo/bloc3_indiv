ˆì
~/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Services/RabbitMQConsumerService.cs
	namespace 	
MurImageService
 
. 
Services "
;" #
public 
class #
RabbitMQConsumerService $
:% &
BackgroundService' 8
{ 
private 
IConnection 
_connection #
;# $
private 
IModel 
_channel 
; 
private 
readonly 
IServiceProvider %
_serviceProvider& 6
;6 7
private 
readonly 
IConfiguration #
_configuration$ 2
;2 3
private 
readonly 
ILogger 
< #
RabbitMQConsumerService 4
>4 5
_logger6 =
;= >
private 
const 
string 
ExchangeName %
=& '
$str( 7
;7 8
private 
const 
string 
	QueueName "
=# $
$str% <
;< =
private 
const 
string 

RoutingKey #
=$ %
$str& =
;= >
private 
static 
readonly 
Counter #"
MessageReceivedCounter$ :
=; <
Metrics= D
. 	
CreateCounter	 
( 
$str :
,: ;
$str< m
,m n
new  
CounterConfiguration $
{ 

LabelNames 
= 
new  
[  !
]! "
{# $
$str% 2
,2 3
$str4 <
}= >
} 
) 
; 
private 
static 
readonly 
Counter #"
PositionUpdatesCounter$ :
=; <
Metrics= D
.   	
CreateCounter  	 
(   
$str   9
,  9 :
$str  ; n
)  n o
;  o p
private"" 
static"" 
readonly"" 
Gauge"" ! 
ActivePositionsGauge""" 6
=""7 8
Metrics""9 @
.## 	
CreateGauge##	 
(## 
$str## 1
,##1 2
$str##3 V
)##V W
;##W X
private%% 
static%% 
readonly%% 
	Histogram%% %!
MessageProcessingTime%%& ;
=%%< =
Metrics%%> E
.&& 	
CreateHistogram&&	 
(&& 
$str&& ?
,&&? @
$str'' 7
,''7 8
new(( "
HistogramConfiguration(( &
{)) 
Buckets** 
=** 
	Histogram** #
.**# $
ExponentialBuckets**$ 6
(**6 7
$num**7 ;
,**; <
$num**= >
,**> ?
$num**@ B
)**B C
}++ 
)++ 
;++ 
public-- 
#
RabbitMQConsumerService-- "
(--" #
IServiceProvider.. 
serviceProvider.. (
,..( )
IConfiguration// 
configuration// $
,//$ %
ILogger00 
<00 #
RabbitMQConsumerService00 '
>00' (
logger00) /
)00/ 0
{11 
_serviceProvider22 
=22 
serviceProvider22 *
;22* +
_configuration33 
=33 
configuration33 &
;33& '
_logger44 
=44 
logger44 
;44 
}55 
public77 

override77 
Task77 

StartAsync77 #
(77# $
CancellationToken77$ 5
cancellationToken776 G
)77G H
{88 
_logger99 
.99 
LogInformation99 
(99 
$str99 F
)99F G
;99G H
try;; 
{<< 	
var== 
factory== 
=== 
new== 
ConnectionFactory== /
{>> 
HostName?? 
=?? 
_configuration?? )
[??) *
$str??* 9
]??9 :
????; =
$str??> I
,??I J
Port@@ 
=@@ 
int@@ 
.@@ 
Parse@@  
(@@  !
_configuration@@! /
[@@/ 0
$str@@0 ?
]@@? @
??@@A C
$str@@D J
)@@J K
,@@K L
UserNameAA 
=AA 
_configurationAA )
[AA) *
$strAA* =
]AA= >
??AA? A
$strAAB I
,AAI J
PasswordBB 
=BB 
_configurationBB )
[BB) *
$strBB* =
]BB= >
??BB? A
$strBBB I
}CC 
;CC 
_connectionEE 
=EE 
factoryEE !
.EE! "
CreateConnectionEE" 2
(EE2 3
)EE3 4
;EE4 5
_channelFF 
=FF 
_connectionFF "
.FF" #
CreateModelFF# .
(FF. /
)FF/ 0
;FF0 1
_channelII 
.II 
ExchangeDeclareII $
(II$ %
ExchangeNameII% 1
,II1 2
ExchangeTypeII3 ?
.II? @
TopicII@ E
,IIE F
durableIIG N
:IIN O
trueIIP T
)IIT U
;IIU V
_channelJJ 
.JJ 
QueueDeclareJJ !
(JJ! "
	QueueNameJJ" +
,JJ+ ,
durableJJ- 4
:JJ4 5
trueJJ6 :
,JJ: ;
	exclusiveJJ< E
:JJE F
falseJJG L
,JJL M

autoDeleteJJN X
:JJX Y
falseJJZ _
)JJ_ `
;JJ` a
_channelKK 
.KK 
	QueueBindKK 
(KK 
	QueueNameKK (
,KK( )
ExchangeNameKK* 6
,KK6 7

RoutingKeyKK8 B
)KKB C
;KKC D
_loggerMM 
.MM 
LogInformationMM "
(MM" #
$strMM# D
)MMD E
;MME F*
InitializeActivePositionMetricPP *
(PP* +
)PP+ ,
;PP, -
}QQ 	
catchRR 
(RR 
	ExceptionRR 
exRR 
)RR 
{SS 	
_loggerTT 
.TT 
LogErrorTT 
(TT 
exTT 
,TT  
$strTT! I
)TTI J
;TTJ K
throwUU 
;UU 
}VV 	
returnXX 
baseXX 
.XX 

StartAsyncXX 
(XX 
cancellationTokenXX 0
)XX0 1
;XX1 2
}YY 
private[[ 
void[[ *
InitializeActivePositionMetric[[ /
([[/ 0
)[[0 1
{\\ 
try]] 
{^^ 	
using__ 
var__ 
scope__ 
=__ 
_serviceProvider__ .
.__. /
CreateScope__/ :
(__: ;
)__; <
;__< =
var`` 
	dbContext`` 
=`` 
scope`` !
.``! "
ServiceProvider``" 1
.``1 2
GetRequiredService``2 D
<``D E
MurImageDbContext``E V
>``V W
(``W X
)``X Y
;``Y Z
varbb 
activePositionCountbb #
=bb$ %
	dbContextbb& /
.bb/ 0
	Positionsbb0 9
.cc 
Countcc 
(cc 
pcc 
=>cc 
pcc 
.cc 

CodeCameracc (
!=cc) +
nullcc, 0
&&cc1 3
pcc4 5
.cc5 6
EstActifcc6 >
)cc> ?
;cc? @ 
ActivePositionsGaugeee  
.ee  !
Setee! $
(ee$ %
activePositionCountee% 8
)ee8 9
;ee9 :
_loggergg 
.gg 
LogInformationgg "
(gg" #
$"gg# %
$strgg% Q
{ggQ R
activePositionCountggR e
}gge f
$strggf x
"ggx y
)ggy z
;ggz {
}hh 	
catchii 
(ii 
	Exceptionii 
exii 
)ii 
{jj 	
_loggerkk 
.kk 
LogErrorkk 
(kk 
exkk 
,kk  
$strkk! g
)kkg h
;kkh i
}ll 	
}mm 
	protectedoo 
overrideoo 
Taskoo 
ExecuteAsyncoo (
(oo( )
CancellationTokenoo) :
stoppingTokenoo; H
)ooH I
{pp 
tryqq 
{rr 	
varss 
consumerss 
=ss 
newss !
EventingBasicConsumerss 4
(ss4 5
_channelss5 =
)ss= >
;ss> ?
consumeruu 
.uu 
Receiveduu 
+=uu  
asyncuu! &
(uu' (
senderuu( .
,uu. /
argsuu0 4
)uu4 5
=>uu6 8
{vv 
tryww 
{xx 
usingyy 
(yy !
MessageProcessingTimeyy 0
.yy0 1
NewTimeryy1 9
(yy9 :
)yy: ;
)yy; <
{zz 
var{{ 
body{{  
={{! "
args{{# '
.{{' (
Body{{( ,
.{{, -
ToArray{{- 4
({{4 5
){{5 6
;{{6 7
var|| 
messageJson|| '
=||( )
Encoding||* 2
.||2 3
UTF8||3 7
.||7 8
	GetString||8 A
(||A B
body||B F
)||F G
;||G H
var}} 
message}} #
=}}$ %
JsonSerializer}}& 4
.}}4 5
Deserialize}}5 @
<}}@ A&
CameraStatusChangedMessage}}A [
>}}[ \
(}}\ ]
messageJson}}] h
)}}h i
;}}i j
if 
( 
message #
!=$ &
null' +
)+ ,
{
ÄÄ $
MessageReceivedCounter
ÅÅ 2
.
ÇÇ  !

WithLabels
ÇÇ! +
(
ÇÇ+ ,
message
ÇÇ, 3
.
ÇÇ3 4

CameraCode
ÇÇ4 >
,
ÇÇ> ?
message
ÇÇ@ G
.
ÇÇG H
EstAfficher
ÇÇH S
?
ÇÇT U
$str
ÇÇV a
:
ÇÇb c
$str
ÇÇd q
)
ÇÇq r
.
ÉÉ  !
Inc
ÉÉ! $
(
ÉÉ$ %
)
ÉÉ% &
;
ÉÉ& '
await
ÖÖ !'
HandleCameraStatusChanged
ÖÖ" ;
(
ÖÖ; <
message
ÖÖ< C
)
ÖÖC D
;
ÖÖD E
}
ÜÜ 
_channel
àà  
.
àà  !
BasicAck
àà! )
(
àà) *
args
àà* .
.
àà. /
DeliveryTag
àà/ :
,
àà: ;
false
àà< A
)
ààA B
;
ààB C
}
ââ 
}
ää 
catch
ãã 
(
ãã 
	Exception
ãã  
ex
ãã! #
)
ãã# $
{
åå 
_logger
çç 
.
çç 
LogError
çç $
(
çç$ %
ex
çç% '
,
çç' (
$str
çç) O
)
ççO P
;
ççP Q
_channel
éé 
.
éé 
	BasicNack
éé &
(
éé& '
args
éé' +
.
éé+ ,
DeliveryTag
éé, 7
,
éé7 8
false
éé9 >
,
éé> ?
true
éé@ D
)
ééD E
;
ééE F
}
èè 
}
êê 
;
êê 
_channel
íí 
.
íí 
BasicConsume
íí !
(
íí! "
	QueueName
íí" +
,
íí+ ,
false
íí- 2
,
íí2 3
consumer
íí4 <
)
íí< =
;
íí= >
_logger
îî 
.
îî 
LogInformation
îî "
(
îî" #
$str
îî# G
)
îîG H
;
îîH I
return
ññ 
Task
ññ 
.
ññ 
CompletedTask
ññ %
;
ññ% &
}
óó 	
catch
òò 
(
òò 
	Exception
òò 
ex
òò 
)
òò 
{
ôô 	
_logger
öö 
.
öö 
LogError
öö 
(
öö 
ex
öö 
,
öö  
$str
öö! R
)
ööR S
;
ööS T
return
õõ 
Task
õõ 
.
õõ 
CompletedTask
õõ %
;
õõ% &
}
úú 	
}
ùù 
private
üü 
async
üü 
Task
üü '
HandleCameraStatusChanged
üü 0
(
üü0 1(
CameraStatusChangedMessage
üü1 K
message
üüL S
)
üüS T
{
†† 
_logger
°° 
.
°° 
LogInformation
°° 
(
°° 
$"
°° !
$str
°°! 6
{
°°6 7
message
°°7 >
.
°°> ?

CameraCode
°°? I
}
°°I J
$str
°°J O
{
°°O P
(
°°P Q
message
°°Q X
.
°°X Y
EstAfficher
°°Y d
?
°°e f
$str
°°g q
:
°°r s
$str
°°t }
)
°°} ~
}
°°~ 
$str°° Ç
{°°Ç É
message°°É ä
.°°ä ã
	Timestamp°°ã î
}°°î ï
"°°ï ñ
)°°ñ ó
;°°ó ò
try
££ 
{
§§ 	
using
•• 
var
•• 
scope
•• 
=
•• 
_serviceProvider
•• .
.
••. /
CreateScope
••/ :
(
••: ;
)
••; <
;
••< =
var
¶¶ 
	dbContext
¶¶ 
=
¶¶ 
scope
¶¶ !
.
¶¶! "
ServiceProvider
¶¶" 1
.
¶¶1 2 
GetRequiredService
¶¶2 D
<
¶¶D E
MurImageDbContext
¶¶E V
>
¶¶V W
(
¶¶W X
)
¶¶X Y
;
¶¶Y Z
var
©© 
	positions
©© 
=
©© 
await
©© !
	dbContext
©©" +
.
©©+ ,
	Positions
©©, 5
.
™™ 
Where
™™ 
(
™™ 
p
™™ 
=>
™™ 
p
™™ 
.
™™ 

CodeCamera
™™ (
==
™™) +
message
™™, 3
.
™™3 4

CameraCode
™™4 >
)
™™> ?
.
´´ 
ToListAsync
´´ 
(
´´ 
)
´´ 
;
´´ 
_logger
≠≠ 
.
≠≠ 
LogInformation
≠≠ "
(
≠≠" #
$"
≠≠# %
$str
≠≠% G
{
≠≠G H
message
≠≠H O
.
≠≠O P

CameraCode
≠≠P Z
}
≠≠Z [
$str
≠≠[ ]
{
≠≠] ^
	positions
≠≠^ g
.
≠≠g h
Count
≠≠h m
}
≠≠m n
"
≠≠n o
)
≠≠o p
;
≠≠p q
bool
∞∞ 
positionsUpdated
∞∞ !
=
∞∞" #
false
∞∞$ )
;
∞∞) *
foreach
±± 
(
±± 
var
±± 
position
±± !
in
±±" $
	positions
±±% .
)
±±. /
{
≤≤ 
if
¥¥ 
(
¥¥ 
position
¥¥ 
.
¥¥ 
EstActif
¥¥ %
!=
¥¥& (
message
¥¥) 0
.
¥¥0 1
EstAfficher
¥¥1 <
)
¥¥< =
{
µµ 
if
∑∑ 
(
∑∑ 
message
∑∑ 
.
∑∑  
EstAfficher
∑∑  +
)
∑∑+ ,
{
∏∏ "
ActivePositionsGauge
ππ ,
.
ππ, -
Inc
ππ- 0
(
ππ0 1
)
ππ1 2
;
ππ2 3
}
∫∫ 
else
ªª 
{
ºº "
ActivePositionsGauge
ΩΩ ,
.
ΩΩ, -
Dec
ΩΩ- 0
(
ΩΩ0 1
)
ΩΩ1 2
;
ΩΩ2 3
}
ææ 
}
øø 
position
¡¡ 
.
¡¡ 
EstActif
¡¡ !
=
¡¡" #
message
¡¡$ +
.
¡¡+ ,
EstAfficher
¡¡, 7
;
¡¡7 8
_logger
¬¬ 
.
¬¬ 
LogInformation
¬¬ &
(
¬¬& '
$"
¬¬' )
$str
¬¬) 2
{
¬¬2 3
position
¬¬3 ;
.
¬¬; <
Id
¬¬< >
}
¬¬> ?
$str
¬¬? O
{
¬¬O P
position
¬¬P X
.
¬¬X Y

IdMurImage
¬¬Y c
}
¬¬c d
$str
¬¬d }
{
¬¬} ~
position¬¬~ Ü
.¬¬Ü á
EstActif¬¬á è
}¬¬è ê
"¬¬ê ë
)¬¬ë í
;¬¬í ì
positionsUpdated
√√  
=
√√! "
true
√√# '
;
√√' (
}
ƒƒ 
if
∆∆ 
(
∆∆ 
positionsUpdated
∆∆  
)
∆∆  !
{
«« $
PositionUpdatesCounter
…… &
.
……& '
Inc
……' *
(
……* +
	positions
……+ 4
.
……4 5
Count
……5 :
)
……: ;
;
……; <
await
ÃÃ 
	dbContext
ÃÃ 
.
ÃÃ  
SaveChangesAsync
ÃÃ  0
(
ÃÃ0 1
)
ÃÃ1 2
;
ÃÃ2 3
_logger
ÕÕ 
.
ÕÕ 
LogInformation
ÕÕ &
(
ÕÕ& '
$"
ÕÕ' )
$str
ÕÕ) I
{
ÕÕI J
	positions
ÕÕJ S
.
ÕÕS T
Count
ÕÕT Y
}
ÕÕY Z
$str
ÕÕZ d
"
ÕÕd e
)
ÕÕe f
;
ÕÕf g
}
ŒŒ 
}
œœ 	
catch
–– 
(
–– 
	Exception
–– 
ex
–– 
)
–– 
{
—— 	
_logger
““ 
.
““ 
LogError
““ 
(
““ 
ex
““ 
,
““  
$"
““! #
$str
““# W
{
““W X
message
““X _
.
““_ `

CameraCode
““` j
}
““j k
"
““k l
)
““l m
;
““m n
}
”” 	
}
‘‘ 
public
÷÷ 

override
÷÷ 
Task
÷÷ 
	StopAsync
÷÷ "
(
÷÷" #
CancellationToken
÷÷# 4
cancellationToken
÷÷5 F
)
÷÷F G
{
◊◊ 
_logger
ÿÿ 
.
ÿÿ 
LogInformation
ÿÿ 
(
ÿÿ 
$str
ÿÿ E
)
ÿÿE F
;
ÿÿF G
_channel
⁄⁄ 
?
⁄⁄ 
.
⁄⁄ 
Close
⁄⁄ 
(
⁄⁄ 
)
⁄⁄ 
;
⁄⁄ 
_connection
€€ 
?
€€ 
.
€€ 
Close
€€ 
(
€€ 
)
€€ 
;
€€ 
return
›› 
base
›› 
.
›› 
	StopAsync
›› 
(
›› 
cancellationToken
›› /
)
››/ 0
;
››0 1
}
ﬁﬁ 
public
‡‡ 

override
‡‡ 
void
‡‡ 
Dispose
‡‡  
(
‡‡  !
)
‡‡! "
{
·· 
_channel
‚‚ 
?
‚‚ 
.
‚‚ 
Dispose
‚‚ 
(
‚‚ 
)
‚‚ 
;
‚‚ 
_connection
„„ 
?
„„ 
.
„„ 
Dispose
„„ 
(
„„ 
)
„„ 
;
„„ 
base
‰‰ 
.
‰‰ 
Dispose
‰‰ 
(
‰‰ 
)
‰‰ 
;
‰‰ 
}
ÂÂ 
}ÊÊ ˇj
e/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder		 
.		 
Services		 
.		 
AddControllers		 
(		  
)		  !
;		! "
builder 
. 
Services 
. #
AddEndpointsApiExplorer (
(( )
)) *
;* +
builder 
. 
Services 
. 
AddSwaggerGen 
( 
)  
;  !
builder 
. 
Services 
. 
AddDbContext 
< 
MurImageDbContext /
>/ 0
(0 1
options1 8
=>9 ;
options 
. 
	UseNpgsql 
( 
builder 
. 
Configuration +
.+ ,
GetConnectionString, ?
(? @
$str@ S
)S T
)T U
)U V
;V W
builder 
. 
Services 
. 
AddHostedService !
<! "#
RabbitMQConsumerService" 9
>9 :
(: ;
); <
;< =
builder 
. 
Services 
. 
AddCors 
( 
options  
=>! #
{ 
options 
. 
	AddPolicy 
( 
$str  
,  !
builder 
=> 
builder 
. 
AllowAnyOrigin )
() *
)* +
.+ ,
AllowAnyMethod, :
(: ;
); <
.< =
AllowAnyHeader= K
(K L
)L M
)M N
;N O
} 
) 
; 
var 
app 
= 	
builder
 
. 
Build 
( 
) 
; 
if 
( 
app 
. 
Environment 
. 
IsDevelopment !
(! "
)" #
)# $
{   
app!! 
.!! 

UseSwagger!! 
(!! 
)!! 
;!! 
app"" 
."" 
UseSwaggerUI"" 
("" 
)"" 
;"" 
}## 
app&& 
.&& 
UseMetricServer&& 
(&& 
)&& 
;&& 
app'' 
.'' 
UseHttpMetrics'' 
('' 
)'' 
;'' 
using** 
(** 
var** 

scope** 
=** 
app** 
.** 
Services** 
.**  
CreateScope**  +
(**+ ,
)**, -
)**- .
{++ 
var,, 
	dbContext,, 
=,, 
scope,, 
.,, 
ServiceProvider,, )
.,,) *
GetRequiredService,,* <
<,,< =
MurImageDbContext,,= N
>,,N O
(,,O P
),,P Q
;,,Q R
var.. 

retryCount.. 
=.. 
$num.. 
;.. 
const// 	
int//
 

maxRetries// 
=// 
$num// 
;// 
var00 
delay00 
=00 
TimeSpan00 
.00 
FromSeconds00 $
(00$ %
$num00% &
)00& '
;00' (
while22 	
(22
 

retryCount22 
<22 

maxRetries22 "
)22" #
{33 
try44 
{55 	
	dbContext66 
.66 
Database66 
.66 
Migrate66 &
(66& '
)66' (
;66( )
if99 
(99 
!99 
	dbContext99 
.99 
	MurImages99 $
.99$ %
Any99% (
(99( )
)99) *
)99* +
{:: 
var<< 
	murImage1<< 
=<< 
new<<  #
MurImage<<$ ,
{<<- .
Nom<</ 2
=<<3 4
$str<<5 Q
}<<R S
;<<S T
var== 
	murImage2== 
=== 
new==  #
MurImage==$ ,
{==- .
Nom==/ 2
===3 4
$str==5 U
}==V W
;==W X
	dbContext@@ 
.@@ 
	MurImages@@ #
.@@# $
AddRange@@$ ,
(@@, -
new@@- 0
List@@1 5
<@@5 6
MurImage@@6 >
>@@> ?
{@@@ A
	murImage1@@B K
,@@K L
	murImage2@@M V
}@@W X
)@@X Y
;@@Y Z
	dbContextAA 
.AA 
SaveChangesAA %
(AA% &
)AA& '
;AA' (
varDD 
positionsMur1DD !
=DD" #
newDD$ '
ListDD( ,
<DD, -
PositionDD- 5
>DD5 6
{EE 
newFF 
PositionFF  
{FF! "

IdMurImageFF# -
=FF. /
	murImage1FF0 9
.FF9 :
IdFF: <
,FF< =

CodeCameraFF> H
=FFI J
$strFFK P
,FFP Q
EstActifFFR Z
=FF[ \
trueFF] a
}FFb c
,FFc d
newGG 
PositionGG  
{GG! "

IdMurImageGG# -
=GG. /
	murImage1GG0 9
.GG9 :
IdGG: <
,GG< =

CodeCameraGG> H
=GGI J
$strGGK P
,GGP Q
EstActifGGR Z
=GG[ \
trueGG] a
}GGb c
,GGc d
newHH 
PositionHH  
{HH! "

IdMurImageHH# -
=HH. /
	murImage1HH0 9
.HH9 :
IdHH: <
,HH< =

CodeCameraHH> H
=HHI J
$strHHK P
,HHP Q
EstActifHHR Z
=HH[ \
trueHH] a
}HHb c
,HHc d
newII 
PositionII  
{II! "

IdMurImageII# -
=II. /
	murImage1II0 9
.II9 :
IdII: <
,II< =

CodeCameraII> H
=III J
$strIIK P
,IIP Q
EstActifIIR Z
=II[ \
trueII] a
}IIb c
,IIc d
newJJ 
PositionJJ  
{JJ! "

IdMurImageJJ# -
=JJ. /
	murImage1JJ0 9
.JJ9 :
IdJJ: <
,JJ< =

CodeCameraJJ> H
=JJI J
$strJJK P
,JJP Q
EstActifJJR Z
=JJ[ \
trueJJ] a
}JJb c
,JJc d
newKK 
PositionKK  
{KK! "

IdMurImageKK# -
=KK. /
	murImage1KK0 9
.KK9 :
IdKK: <
,KK< =

CodeCameraKK> H
=KKI J
$strKKK P
,KKP Q
EstActifKKR Z
=KK[ \
trueKK] a
}KKb c
,KKc d
newLL 
PositionLL  
{LL! "

IdMurImageLL# -
=LL. /
	murImage1LL0 9
.LL9 :
IdLL: <
,LL< =

CodeCameraLL> H
=LLI J
$strLLK P
,LLP Q
EstActifLLR Z
=LL[ \
trueLL] a
}LLb c
,LLc d
newMM 
PositionMM  
{MM! "

IdMurImageMM# -
=MM. /
	murImage1MM0 9
.MM9 :
IdMM: <
,MM< =

CodeCameraMM> H
=MMI J
$strMMK P
,MMP Q
EstActifMMR Z
=MM[ \
falseMM] b
}MMc d
,MMd e
newNN 
PositionNN  
{NN! "

IdMurImageNN# -
=NN. /
	murImage1NN0 9
.NN9 :
IdNN: <
,NN< =

CodeCameraNN> H
=NNI J
nullNNK O
,NNO P
EstActifNNQ Y
=NNZ [
trueNN\ `
}NNa b
}OO 
;OO 
varRR 
positionsMur2RR !
=RR" #
newRR$ '
ListRR( ,
<RR, -
PositionRR- 5
>RR5 6
{SS 
newTT 
PositionTT  
{TT! "

IdMurImageTT# -
=TT. /
	murImage2TT0 9
.TT9 :
IdTT: <
,TT< =

CodeCameraTT> H
=TTI J
$strTTK P
,TTP Q
EstActifTTR Z
=TT[ \
trueTT] a
}TTb c
,TTc d
newUU 
PositionUU  
{UU! "

IdMurImageUU# -
=UU. /
	murImage2UU0 9
.UU9 :
IdUU: <
,UU< =

CodeCameraUU> H
=UUI J
$strUUK P
,UUP Q
EstActifUUR Z
=UU[ \
trueUU] a
}UUb c
,UUc d
newVV 
PositionVV  
{VV! "

IdMurImageVV# -
=VV. /
	murImage2VV0 9
.VV9 :
IdVV: <
,VV< =

CodeCameraVV> H
=VVI J
$strVVK P
,VVP Q
EstActifVVR Z
=VV[ \
trueVV] a
}VVb c
,VVc d
newWW 
PositionWW  
{WW! "

IdMurImageWW# -
=WW. /
	murImage2WW0 9
.WW9 :
IdWW: <
,WW< =

CodeCameraWW> H
=WWI J
$strWWK P
,WWP Q
EstActifWWR Z
=WW[ \
trueWW] a
}WWb c
,WWc d
newXX 
PositionXX  
{XX! "

IdMurImageXX# -
=XX. /
	murImage2XX0 9
.XX9 :
IdXX: <
,XX< =

CodeCameraXX> H
=XXI J
$strXXK P
,XXP Q
EstActifXXR Z
=XX[ \
trueXX] a
}XXb c
,XXc d
newYY 
PositionYY  
{YY! "

IdMurImageYY# -
=YY. /
	murImage2YY0 9
.YY9 :
IdYY: <
,YY< =

CodeCameraYY> H
=YYI J
$strYYK P
,YYP Q
EstActifYYR Z
=YY[ \
trueYY] a
}YYb c
,YYc d
newZZ 
PositionZZ  
{ZZ! "

IdMurImageZZ# -
=ZZ. /
	murImage2ZZ0 9
.ZZ9 :
IdZZ: <
,ZZ< =

CodeCameraZZ> H
=ZZI J
$strZZK P
,ZZP Q
EstActifZZR Z
=ZZ[ \
trueZZ] a
}ZZb c
,ZZc d
new[[ 
Position[[  
{[[! "

IdMurImage[[# -
=[[. /
	murImage2[[0 9
.[[9 :
Id[[: <
,[[< =

CodeCamera[[> H
=[[I J
null[[K O
,[[O P
EstActif[[Q Y
=[[Z [
true[[\ `
}[[a b
,[[b c
new\\ 
Position\\  
{\\! "

IdMurImage\\# -
=\\. /
	murImage2\\0 9
.\\9 :
Id\\: <
,\\< =

CodeCamera\\> H
=\\I J
null\\K O
,\\O P
EstActif\\Q Y
=\\Z [
true\\\ `
}\\a b
}]] 
;]] 
	dbContext`` 
.`` 
	Positions`` #
.``# $
AddRange``$ ,
(``, -
positionsMur1``- :
)``: ;
;``; <
	dbContextaa 
.aa 
	Positionsaa #
.aa# $
AddRangeaa$ ,
(aa, -
positionsMur2aa- :
)aa: ;
;aa; <
	dbContextbb 
.bb 
SaveChangesbb %
(bb% &
)bb& '
;bb' (
Consoledd 
.dd 
	WriteLinedd !
(dd! "
$strdd" o
)ddo p
;ddp q
}ee 
Consolegg 
.gg 
	WriteLinegg 
(gg 
$strgg B
)ggB C
;ggC D
breakhh 
;hh 
}ii 	
catchjj 
(jj 
	Exceptionjj 
exjj 
)jj 
{kk 	

retryCountll 
++ll 
;ll 
Consolemm 
.mm 
	WriteLinemm 
(mm 
$"mm  
$strmm  *
{mm* +

retryCountmm+ 5
}mm5 6
$strmm6 7
{mm7 8

maxRetriesmm8 B
}mmB C
$strmmC x
{mmx y
exmmy {
.mm{ |
Message	mm| É
}
mmÉ Ñ
"
mmÑ Ö
)
mmÖ Ü
;
mmÜ á
ifoo 
(oo 

retryCountoo 
<oo 

maxRetriesoo '
)oo' (
{pp 
Consoleqq 
.qq 
	WriteLineqq !
(qq! "
$"qq" $
$strqq$ <
{qq< =
delayqq= B
.qqB C
TotalSecondsqqC O
}qqO P
$strqqP \
"qq\ ]
)qq] ^
;qq^ _
Threadrr 
.rr 
Sleeprr 
(rr 
delayrr "
)rr" #
;rr# $
}ss 
elsett 
{uu 
Consolevv 
.vv 
	WriteLinevv !
(vv! "
$strvv" o
)vvo p
;vvp q
throwww 
;ww 
}xx 
}yy 	
}zz 
}{{ 
app}} 
.}} 
UseCors}} 
(}} 
$str}} 
)}} 
;}} 
app~~ 
.~~ 

UseRouting~~ 
(~~ 
)~~ 
;~~ 
appÄÄ 
.
ÄÄ 
UseAuthorization
ÄÄ 
(
ÄÄ 
)
ÄÄ 
;
ÄÄ 
appÅÅ 
.
ÅÅ 
MapControllers
ÅÅ 
(
ÅÅ 
)
ÅÅ 
;
ÅÅ 
appÉÉ 
.
ÉÉ 
Run
ÉÉ 
(
ÉÉ 
)
ÉÉ 	
;
ÉÉ	 
÷

m/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Models/Position.cs
	namespace 	
MurImageService
 
. 
Models  
{ 
public 

class 
Position 
{ 
[		 	
Key			 
]		 
public

 
int

 
Id

 
{

 
get

 
;

 
set

  
;

  !
}

" #
[ 	

ForeignKey	 
( 
$str 
) 
]  
public 
int 

IdMurImage 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
? 

CodeCamera !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
bool 
EstActif 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
true- 1
;1 2
[ 	

JsonIgnore	 
] 
public 
MurImage 
? 
MurImage !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ’&
v/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Models/MurImageDbContext.cs
	namespace 	
MurImageService
 
. 
Models  
{ 
public 

class 
MurImageDbContext "
:# $
	DbContext% .
{ 
public 
MurImageDbContext  
(  !
DbContextOptions! 1
<1 2
MurImageDbContext2 C
>C D
optionsE L
)L M
: 
base 
( 
options 
) 
{		 	
}

 	
public 
DbSet 
< 
MurImage 
> 
	MurImages (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 
DbSet 
< 
Position 
> 
	Positions (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
modelBuilder 
. 
Entity 
<  
MurImage  (
>( )
() *
)* +
.+ ,
ToTable, 3
(3 4
$str4 ?
)? @
;@ A
modelBuilder 
. 
Entity 
<  
Position  (
>( )
() *
)* +
.+ ,
ToTable, 3
(3 4
$str4 >
)> ?
;? @
modelBuilder 
. 
Entity 
<  
MurImage  (
>( )
() *
)* +
.+ ,
Property, 4
(4 5
m5 6
=>7 9
m: ;
.; <
Id< >
)> ?
.? @
HasColumnName@ M
(M N
$strN R
)R S
;S T
modelBuilder 
. 
Entity 
<  
MurImage  (
>( )
() *
)* +
.+ ,
Property, 4
(4 5
m5 6
=>7 9
m: ;
.; <
Nom< ?
)? @
.@ A
HasColumnNameA N
(N O
$strO T
)T U
;U V
modelBuilder 
. 
Entity 
<  
Position  (
>( )
() *
)* +
.+ ,
Property, 4
(4 5
p5 6
=>7 9
p: ;
.; <
Id< >
)> ?
.? @
HasColumnName@ M
(M N
$strN R
)R S
;S T
modelBuilder 
. 
Entity 
<  
Position  (
>( )
() *
)* +
.+ ,
Property, 4
(4 5
p5 6
=>7 9
p: ;
.; <

IdMurImage< F
)F G
.G H
HasColumnNameH U
(U V
$strV c
)c d
;d e
modelBuilder 
. 
Entity 
<  
Position  (
>( )
() *
)* +
.+ ,
Property, 4
(4 5
p5 6
=>7 9
p: ;
.; <

CodeCamera< F
)F G
.G H
HasColumnNameH U
(U V
$strV c
)c d
.d e

IsRequirede o
(o p
falsep u
)u v
;v w
modelBuilder 
. 
Entity 
<  
Position  (
>( )
() *
)* +
.+ ,
Property, 4
(4 5
p5 6
=>7 9
p: ;
.; <
EstActif< D
)D E
.E F
HasColumnNameF S
(S T
$strT _
)_ `
.` a
HasDefaultValuea p
(p q
trueq u
)u v
;v w
modelBuilder 
. 
Entity 
<  
Position  (
>( )
() *
)* +
. 
HasOne 
( 
p 
=> 
p 
. 
MurImage '
)' (
.   
WithMany   
(   
m   
=>   
m    
.    !
	Positions  ! *
)  * +
.!! 
HasForeignKey!! 
(!! 
p!!  
=>!!! #
p!!$ %
.!!% &

IdMurImage!!& 0
)!!0 1
;!!1 2
}"" 	
}## 
}$$ Ñ
m/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Models/MurImage.cs
	namespace 	
MurImageService
 
. 
Models  
{ 
public 

class 
MurImage 
{ 
[ 	
Key	 
] 
public		 
int		 
Id		 
{		 
get		 
;		 
set		  
;		  !
}		" #
[ 	
Required	 
] 
[ 	
StringLength	 
( 
$num 
) 
] 
public 
string 
Nom 
{ 
get 
;  
set! $
;$ %
}& '
public 
ICollection 
< 
Position #
># $
	Positions% .
{/ 0
get1 4
;4 5
set6 9
;9 :
}; <
} 
} à
ç/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Migrations/20250412131452_AjoutEstActifPosition.cs
	namespace 	
MurImageService
 
. 

Migrations $
{ 
public 

partial 
class !
AjoutEstActifPosition .
:/ 0
	Migration1 :
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
	AddColumn &
<& '
bool' +
>+ ,
(, -
name 
: 
$str !
,! "
table 
: 
$str !
,! "
type 
: 
$str 
,  
nullable 
: 
false 
,  
defaultValue 
: 
true "
)" #
;# $
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 

DropColumn '
(' (
name 
: 
$str !
,! "
table 
: 
$str !
)! "
;" #
} 	
} 
} ¸

Å/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Migrations/20250412093124_codeAjout.cs
	namespace 	
MurImageService
 
. 

Migrations $
{ 
public 

partial 
class 
	codeAjout "
:# $
	Migration% .
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
RenameColumn )
() *
name 
: 
$str "
," #
table 
: 
$str !
,! "
newName 
: 
$str &
)& '
;' (
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
RenameColumn )
() *
name 
: 
$str #
,# $
table 
: 
$str !
,! "
newName 
: 
$str %
)% &
;& '
} 	
} 
} ﬁ(
Ö/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Migrations/20250412085147_InitialCreate.cs
	namespace 	
MurImageService
 
. 

Migrations $
{ 
public		 

partial		 
class		 
InitialCreate		 &
:		' (
	Migration		) 2
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str !
,! "
columns 
: 
table 
=> !
new" %
{ 
id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
. 

Annotation #
(# $
$str$ D
,D E)
NpgsqlValueGenerationStrategyF c
.c d#
IdentityByDefaultColumnd {
){ |
,| }
nom 
= 
table 
.  
Column  &
<& '
string' -
>- .
(. /
type/ 3
:3 4
$str5 M
,M N
	maxLengthO X
:X Y
$numZ ]
,] ^
nullable_ g
:g h
falsei n
)n o
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 3
,3 4
x5 6
=>7 9
x: ;
.; <
id< >
)> ?
;? @
} 
) 
; 
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str  
,  !
columns 
: 
table 
=> !
new" %
{ 
id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
.   

Annotation   #
(  # $
$str  $ D
,  D E)
NpgsqlValueGenerationStrategy  F c
.  c d#
IdentityByDefaultColumn  d {
)  { |
,  | }
id_murimage!! 
=!!  !
table!!" '
.!!' (
Column!!( .
<!!. /
int!!/ 2
>!!2 3
(!!3 4
type!!4 8
:!!8 9
$str!!: C
,!!C D
nullable!!E M
:!!M N
false!!O T
)!!T U
,!!U V

nom_camera"" 
=""  
table""! &
.""& '
Column""' -
<""- .
string"". 4
>""4 5
(""5 6
type""6 :
:"": ;
$str""< B
,""B C
nullable""D L
:""L M
true""N R
)""R S
}## 
,## 
constraints$$ 
:$$ 
table$$ "
=>$$# %
{%% 
table&& 
.&& 

PrimaryKey&& $
(&&$ %
$str&&% 2
,&&2 3
x&&4 5
=>&&6 8
x&&9 :
.&&: ;
id&&; =
)&&= >
;&&> ?
table'' 
.'' 

ForeignKey'' $
(''$ %
name(( 
:(( 
$str(( A
,((A B
column)) 
:)) 
x))  !
=>))" $
x))% &
.))& '
id_murimage))' 2
,))2 3
principalTable** &
:**& '
$str**( 3
,**3 4
principalColumn++ '
:++' (
$str++) -
,++- .
onDelete,,  
:,,  !
ReferentialAction,," 3
.,,3 4
Cascade,,4 ;
),,; <
;,,< =
}-- 
)-- 
;-- 
migrationBuilder// 
.// 
CreateIndex// (
(//( )
name00 
:00 
$str00 /
,00/ 0
table11 
:11 
$str11 !
,11! "
column22 
:22 
$str22 %
)22% &
;22& '
}33 	
	protected66 
override66 
void66 
Down66  $
(66$ %
MigrationBuilder66% 5
migrationBuilder666 F
)66F G
{77 	
migrationBuilder88 
.88 
	DropTable88 &
(88& '
name99 
:99 
$str99  
)99  !
;99! "
migrationBuilder;; 
.;; 
	DropTable;; &
(;;& '
name<< 
:<< 
$str<< !
)<<! "
;<<" #
}== 	
}>> 
}?? Ü
u/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Messages/CameraMessages.cs
	namespace 	
MurImageService
 
. 
Messages "
{ 
public 

class &
CameraStatusChangedMessage +
{ 
public 
string 

CameraCode  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
bool 
EstAfficher 
{  !
get" %
;% &
set' *
;* +
}, -
public		 
DateTime		 
	Timestamp		 !
{		" #
get		$ '
;		' (
set		) ,
;		, -
}		. /
=		0 1
DateTime		2 :
.		: ;
UtcNow		; A
;		A B
}

 
} çH
x/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Controllers/SeedController.cs
	namespace 	
MurImageService
 
. 
Controllers %
{ 
[ 
ApiController 
] 
[		 
Route		 

(		
 
$str		 
)		 
]		 
public

 

class

 
SeedController

 
:

  !
ControllerBase

" 0
{ 
private 
readonly 
MurImageDbContext *
_context+ 3
;3 4
public 
SeedController 
( 
MurImageDbContext /
context0 7
)7 8
{ 	
_context 
= 
context 
; 
} 	
[ 	
HttpPost	 
] 
public 
async 
Task 
< 
IActionResult '
>' (
SeedData) 1
(1 2
)2 3
{ 	
_context 
. 
	Positions 
. 
RemoveRange *
(* +
_context+ 3
.3 4
	Positions4 =
)= >
;> ?
_context 
. 
	MurImages 
. 
RemoveRange *
(* +
_context+ 3
.3 4
	MurImages4 =
)= >
;> ?
await 
_context 
. 
SaveChangesAsync +
(+ ,
), -
;- .
var 
	murImage1 
= 
new 
MurImage  (
{) *
Nom+ .
=/ 0
$str1 M
}N O
;O P
var 
	murImage2 
= 
new 
MurImage  (
{) *
Nom+ .
=/ 0
$str1 Q
}R S
;S T
await!! 
_context!! 
.!! 
	MurImages!! $
.!!$ %
AddRangeAsync!!% 2
(!!2 3
new!!3 6
List!!7 ;
<!!; <
MurImage!!< D
>!!D E
{!!F G
	murImage1!!H Q
,!!Q R
	murImage2!!S \
}!!] ^
)!!^ _
;!!_ `
await"" 
_context"" 
."" 
SaveChangesAsync"" +
(""+ ,
)"", -
;""- .
var%% 
positionsMur1%% 
=%% 
new%%  #
List%%$ (
<%%( )
Position%%) 1
>%%1 2
{&& 
new'' 
Position'' 
{'' 

IdMurImage'' )
=''* +
	murImage1'', 5
.''5 6
Id''6 8
,''8 9

CodeCamera'': D
=''E F
$str''G L
,''L M
EstActif''N V
=''W X
true''Y ]
}''^ _
,''_ `
new(( 
Position(( 
{(( 

IdMurImage(( )
=((* +
	murImage1((, 5
.((5 6
Id((6 8
,((8 9

CodeCamera((: D
=((E F
$str((G L
,((L M
EstActif((N V
=((W X
true((Y ]
}((^ _
,((_ `
new)) 
Position)) 
{)) 

IdMurImage)) )
=))* +
	murImage1)), 5
.))5 6
Id))6 8
,))8 9

CodeCamera)): D
=))E F
$str))G L
,))L M
EstActif))N V
=))W X
true))Y ]
}))^ _
,))_ `
new** 
Position** 
{** 

IdMurImage** )
=*** +
	murImage1**, 5
.**5 6
Id**6 8
,**8 9

CodeCamera**: D
=**E F
$str**G L
,**L M
EstActif**N V
=**W X
true**Y ]
}**^ _
,**_ `
new++ 
Position++ 
{++ 

IdMurImage++ )
=++* +
	murImage1++, 5
.++5 6
Id++6 8
,++8 9

CodeCamera++: D
=++E F
$str++G L
,++L M
EstActif++N V
=++W X
true++Y ]
}++^ _
,++_ `
new,, 
Position,, 
{,, 

IdMurImage,, )
=,,* +
	murImage1,,, 5
.,,5 6
Id,,6 8
,,,8 9

CodeCamera,,: D
=,,E F
$str,,G L
,,,L M
EstActif,,N V
=,,W X
true,,Y ]
},,^ _
,,,_ `
new-- 
Position-- 
{-- 

IdMurImage-- )
=--* +
	murImage1--, 5
.--5 6
Id--6 8
,--8 9

CodeCamera--: D
=--E F
$str--G L
,--L M
EstActif--N V
=--W X
true--Y ]
}--^ _
,--_ `
new.. 
Position.. 
{.. 

IdMurImage.. )
=..* +
	murImage1.., 5
...5 6
Id..6 8
,..8 9

CodeCamera..: D
=..E F
$str..G L
,..L M
EstActif..N V
=..W X
false..Y ^
}.._ `
,..` a
new// 
Position// 
{// 

IdMurImage// )
=//* +
	murImage1//, 5
.//5 6
Id//6 8
,//8 9

CodeCamera//: D
=//E F
null//G K
,//K L
EstActif//M U
=//V W
true//X \
}//] ^
}00 
;00 
var33 
positionsMur233 
=33 
new33  #
List33$ (
<33( )
Position33) 1
>331 2
{44 
new55 
Position55 
{55 

IdMurImage55 )
=55* +
	murImage255, 5
.555 6
Id556 8
,558 9

CodeCamera55: D
=55E F
$str55G L
,55L M
EstActif55N V
=55W X
true55Y ]
}55^ _
,55_ `
new66 
Position66 
{66 

IdMurImage66 )
=66* +
	murImage266, 5
.665 6
Id666 8
,668 9

CodeCamera66: D
=66E F
$str66G L
,66L M
EstActif66N V
=66W X
true66Y ]
}66^ _
,66_ `
new77 
Position77 
{77 

IdMurImage77 )
=77* +
	murImage277, 5
.775 6
Id776 8
,778 9

CodeCamera77: D
=77E F
$str77G L
,77L M
EstActif77N V
=77W X
true77Y ]
}77^ _
,77_ `
new88 
Position88 
{88 

IdMurImage88 )
=88* +
	murImage288, 5
.885 6
Id886 8
,888 9

CodeCamera88: D
=88E F
$str88G L
,88L M
EstActif88N V
=88W X
true88Y ]
}88^ _
,88_ `
new99 
Position99 
{99 

IdMurImage99 )
=99* +
	murImage299, 5
.995 6
Id996 8
,998 9

CodeCamera99: D
=99E F
$str99G L
,99L M
EstActif99N V
=99W X
true99Y ]
}99^ _
,99_ `
new:: 
Position:: 
{:: 

IdMurImage:: )
=::* +
	murImage2::, 5
.::5 6
Id::6 8
,::8 9

CodeCamera::: D
=::E F
$str::G L
,::L M
EstActif::N V
=::W X
true::Y ]
}::^ _
,::_ `
new;; 
Position;; 
{;; 

IdMurImage;; )
=;;* +
	murImage2;;, 5
.;;5 6
Id;;6 8
,;;8 9

CodeCamera;;: D
=;;E F
$str;;G L
,;;L M
EstActif;;N V
=;;W X
true;;Y ]
};;^ _
,;;_ `
new<< 
Position<< 
{<< 

IdMurImage<< )
=<<* +
	murImage2<<, 5
.<<5 6
Id<<6 8
,<<8 9

CodeCamera<<: D
=<<E F
null<<G K
,<<K L
EstActif<<M U
=<<V W
true<<X \
}<<] ^
,<<^ _
new== 
Position== 
{== 

IdMurImage== )
===* +
	murImage2==, 5
.==5 6
Id==6 8
,==8 9

CodeCamera==: D
===E F
null==G K
,==K L
EstActif==M U
===V W
true==X \
}==] ^
}>> 
;>> 
awaitAA 
_contextAA 
.AA 
	PositionsAA $
.AA$ %
AddRangeAsyncAA% 2
(AA2 3
positionsMur1AA3 @
)AA@ A
;AAA B
awaitBB 
_contextBB 
.BB 
	PositionsBB $
.BB$ %
AddRangeAsyncBB% 2
(BB2 3
positionsMur2BB3 @
)BB@ A
;BBA B
awaitCC 
_contextCC 
.CC 
SaveChangesAsyncCC +
(CC+ ,
)CC, -
;CC- .
returnEE 
OkEE 
(EE 
$strEE W
)EEW X
;EEX Y
}FF 	
}GG 
}HH ¬=
}/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Controllers/PositionsController.cs
	namespace 	
MurImageService
 
. 
Controllers %
{ 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
public		 

class		 
PositionsController		 $
:		% &
ControllerBase		' 5
{

 
private 
readonly 
MurImageDbContext *
_context+ 3
;3 4
public 
PositionsController "
(" #
MurImageDbContext# 4
context5 <
)< =
{ 	
_context 
= 
context 
; 
} 	
[ 	
HttpGet	 
] 
public 
async 
Task 
< 
ActionResult &
<& '
IEnumerable' 2
<2 3
Position3 ;
>; <
>< =
>= >
GetPositions? K
(K L
)L M
{ 	
return 
await 
_context !
.! "
	Positions" +
.+ ,
Include, 3
(3 4
p4 5
=>6 8
p9 :
.: ;
MurImage; C
)C D
.D E
OrderByE L
(L M
pM N
=>O Q
pR S
.S T
IdT V
)V W
.W X
ToListAsyncX c
(c d
)d e
;e f
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
public 
async 
Task 
< 
ActionResult &
<& '
Position' /
>/ 0
>0 1
GetPosition2 =
(= >
int> A
idB D
)D E
{ 	
var 
position 
= 
await  
_context! )
.) *
	Positions* 3
. 
Include 
( 
p 
=> 
p 
.  
MurImage  (
)( )
. 
FirstOrDefaultAsync $
($ %
p% &
=>' )
p* +
.+ ,
Id, .
==/ 1
id2 4
)4 5
;5 6
if!! 
(!! 
position!! 
==!! 
null!!  
)!!  !
{"" 
return## 
NotFound## 
(##  
)##  !
;##! "
}$$ 
return&& 
position&& 
;&& 
}'' 	
[** 	
HttpGet**	 
(** 
$str** (
)**( )
]**) *
public++ 
async++ 
Task++ 
<++ 
ActionResult++ &
<++& '
IEnumerable++' 2
<++2 3
Position++3 ;
>++; <
>++< =
>++= >"
GetPositionsByMurImage++? U
(++U V
int++V Y

murImageId++Z d
)++d e
{,, 	
return-- 
await-- 
_context-- !
.--! "
	Positions--" +
... 
Where.. 
(.. 
p.. 
=>.. 
p.. 
... 

IdMurImage.. (
==..) +

murImageId.., 6
)..6 7
.// 
ToListAsync// 
(// 
)// 
;// 
}00 	
[33 	
HttpPost33	 
]33 
public44 
async44 
Task44 
<44 
ActionResult44 &
<44& '
Position44' /
>44/ 0
>440 1
PostPosition442 >
(44> ?
Position44? G
position44H P
)44P Q
{55 	
_context66 
.66 
	Positions66 
.66 
Add66 "
(66" #
position66# +
)66+ ,
;66, -
await77 
_context77 
.77 
SaveChangesAsync77 +
(77+ ,
)77, -
;77- .
return99 
CreatedAtAction99 "
(99" #
nameof99# )
(99) *
GetPosition99* 5
)995 6
,996 7
new998 ;
{99< =
id99> @
=99A B
position99C K
.99K L
Id99L N
}99O P
,99P Q
position99R Z
)99Z [
;99[ \
}:: 	
[== 	
HttpPut==	 
(== 
$str== 
)== 
]== 
public>> 
async>> 
Task>> 
<>> 
IActionResult>> '
>>>' (
PutPosition>>) 4
(>>4 5
int>>5 8
id>>9 ;
,>>; <
Position>>= E
position>>F N
)>>N O
{?? 	
if@@ 
(@@ 
id@@ 
!=@@ 
position@@ 
.@@ 
Id@@ !
)@@! "
{AA 
returnBB 

BadRequestBB !
(BB! "
)BB" #
;BB# $
}CC 
_contextEE 
.EE 
EntryEE 
(EE 
positionEE #
)EE# $
.EE$ %
StateEE% *
=EE+ ,
EntityStateEE- 8
.EE8 9
ModifiedEE9 A
;EEA B
tryGG 
{HH 
awaitII 
_contextII 
.II 
SaveChangesAsyncII /
(II/ 0
)II0 1
;II1 2
}JJ 
catchKK 
(KK (
DbUpdateConcurrencyExceptionKK /
)KK/ 0
{LL 
ifMM 
(MM 
!MM 
PositionExistsMM #
(MM# $
idMM$ &
)MM& '
)MM' (
{NN 
returnOO 
NotFoundOO #
(OO# $
)OO$ %
;OO% &
}PP 
elseQQ 
{RR 
throwSS 
;SS 
}TT 
}UU 
returnWW 
	NoContentWW 
(WW 
)WW 
;WW 
}XX 	
[[[ 	

HttpDelete[[	 
([[ 
$str[[ 
)[[ 
][[ 
public\\ 
async\\ 
Task\\ 
<\\ 
IActionResult\\ '
>\\' (
DeletePosition\\) 7
(\\7 8
int\\8 ;
id\\< >
)\\> ?
{]] 	
var^^ 
position^^ 
=^^ 
await^^  
_context^^! )
.^^) *
	Positions^^* 3
.^^3 4
	FindAsync^^4 =
(^^= >
id^^> @
)^^@ A
;^^A B
if__ 
(__ 
position__ 
==__ 
null__  
)__  !
{`` 
returnaa 
NotFoundaa 
(aa  
)aa  !
;aa! "
}bb 
_contextdd 
.dd 
	Positionsdd 
.dd 
Removedd %
(dd% &
positiondd& .
)dd. /
;dd/ 0
awaitee 
_contextee 
.ee 
SaveChangesAsyncee +
(ee+ ,
)ee, -
;ee- .
returngg 
	NoContentgg 
(gg 
)gg 
;gg 
}hh 	
privatejj 
booljj 
PositionExistsjj #
(jj# $
intjj$ '
idjj( *
)jj* +
{kk 	
returnll 
_contextll 
.ll 
	Positionsll %
.ll% &
Anyll& )
(ll) *
ell* +
=>ll, .
ell/ 0
.ll0 1
Idll1 3
==ll4 6
idll7 9
)ll9 :
;ll: ;
}mm 	
}nn 
}oo á7
}/Users/loic/Documents/MAALSI/Poc_indiv/microservices-app/mur-image-service/MurImageService/Controllers/MurImagesController.cs
	namespace 	
MurImageService
 
. 
Controllers %
{ 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
public		 

class		 
MurImagesController		 $
:		% &
ControllerBase		' 5
{

 
private 
readonly 
MurImageDbContext *
_context+ 3
;3 4
public 
MurImagesController "
(" #
MurImageDbContext# 4
context5 <
)< =
{ 	
_context 
= 
context 
; 
} 	
[ 	
HttpGet	 
] 
public 
async 
Task 
< 
ActionResult &
<& '
IEnumerable' 2
<2 3
MurImage3 ;
>; <
>< =
>= >
GetMurImages? K
(K L
)L M
{ 	
return 
await 
_context !
.! "
	MurImages" +
.+ ,
Include, 3
(3 4
m4 5
=>6 8
m9 :
.: ;
	Positions; D
.D E
OrderByE L
(L M
pM N
=>O Q
pR S
.S T
IdT V
)V W
)W X
.X Y
ToListAsyncY d
(d e
)e f
;f g
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
public 
async 
Task 
< 
ActionResult &
<& '
MurImage' /
>/ 0
>0 1
GetMurImage2 =
(= >
int> A
idB D
)D E
{ 	
var 
murImage 
= 
await  
_context! )
.) *
	MurImages* 3
. 
Include 
( 
m 
=> 
m 
.  
	Positions  )
)) *
. 
FirstOrDefaultAsync $
($ %
m% &
=>' )
m* +
.+ ,
Id, .
==/ 1
id2 4
)4 5
;5 6
if!! 
(!! 
murImage!! 
==!! 
null!!  
)!!  !
{"" 
return## 
NotFound## 
(##  
)##  !
;##! "
}$$ 
return&& 
murImage&& 
;&& 
}'' 	
[** 	
HttpPost**	 
]** 
public++ 
async++ 
Task++ 
<++ 
ActionResult++ &
<++& '
MurImage++' /
>++/ 0
>++0 1
PostMurImage++2 >
(++> ?
MurImage++? G
murImage++H P
)++P Q
{,, 	
_context-- 
.-- 
	MurImages-- 
.-- 
Add-- "
(--" #
murImage--# +
)--+ ,
;--, -
await.. 
_context.. 
... 
SaveChangesAsync.. +
(..+ ,
).., -
;..- .
return00 
CreatedAtAction00 "
(00" #
nameof00# )
(00) *
GetMurImage00* 5
)005 6
,006 7
new008 ;
{00< =
id00> @
=00A B
murImage00C K
.00K L
Id00L N
}00O P
,00P Q
murImage00R Z
)00Z [
;00[ \
}11 	
[44 	
HttpPut44	 
(44 
$str44 
)44 
]44 
public55 
async55 
Task55 
<55 
IActionResult55 '
>55' (
PutMurImage55) 4
(554 5
int555 8
id559 ;
,55; <
MurImage55= E
murImage55F N
)55N O
{66 	
if77 
(77 
id77 
!=77 
murImage77 
.77 
Id77 !
)77! "
{88 
return99 

BadRequest99 !
(99! "
)99" #
;99# $
}:: 
_context<< 
.<< 
Entry<< 
(<< 
murImage<< #
)<<# $
.<<$ %
State<<% *
=<<+ ,
EntityState<<- 8
.<<8 9
Modified<<9 A
;<<A B
try>> 
{?? 
await@@ 
_context@@ 
.@@ 
SaveChangesAsync@@ /
(@@/ 0
)@@0 1
;@@1 2
}AA 
catchBB 
(BB (
DbUpdateConcurrencyExceptionBB /
)BB/ 0
{CC 
ifDD 
(DD 
!DD 
MurImageExistsDD #
(DD# $
idDD$ &
)DD& '
)DD' (
{EE 
returnFF 
NotFoundFF #
(FF# $
)FF$ %
;FF% &
}GG 
elseHH 
{II 
throwJJ 
;JJ 
}KK 
}LL 
returnNN 
	NoContentNN 
(NN 
)NN 
;NN 
}OO 	
[RR 	

HttpDeleteRR	 
(RR 
$strRR 
)RR 
]RR 
publicSS 
asyncSS 
TaskSS 
<SS 
IActionResultSS '
>SS' (
DeleteMurImageSS) 7
(SS7 8
intSS8 ;
idSS< >
)SS> ?
{TT 	
varUU 
murImageUU 
=UU 
awaitUU  
_contextUU! )
.UU) *
	MurImagesUU* 3
.UU3 4
	FindAsyncUU4 =
(UU= >
idUU> @
)UU@ A
;UUA B
ifVV 
(VV 
murImageVV 
==VV 
nullVV  
)VV  !
{WW 
returnXX 
NotFoundXX 
(XX  
)XX  !
;XX! "
}YY 
_context[[ 
.[[ 
	MurImages[[ 
.[[ 
Remove[[ %
([[% &
murImage[[& .
)[[. /
;[[/ 0
await\\ 
_context\\ 
.\\ 
SaveChangesAsync\\ +
(\\+ ,
)\\, -
;\\- .
return^^ 
	NoContent^^ 
(^^ 
)^^ 
;^^ 
}__ 	
privateaa 
boolaa 
MurImageExistsaa #
(aa# $
intaa$ '
idaa( *
)aa* +
{bb 	
returncc 
_contextcc 
.cc 
	MurImagescc %
.cc% &
Anycc& )
(cc) *
ecc* +
=>cc, .
ecc/ 0
.cc0 1
Idcc1 3
==cc4 6
idcc7 9
)cc9 :
;cc: ;
}dd 	
}ee 
}ff 